<!-- minified by avy <3 -->
<!DOCTYPE html><html><head><title>Quadtree</title><style>body{font-family:Arial,sans-serif;display:flex;flex-direction:column;flex-wrap:nowrap;align-content:center;justify-content:center;align-items:center}canvas{border:1px solid #aaa;background:#f9f9f9;display:block;margin:10px 0}button{margin-right:10px}</style></head><body><h1>Quadtree</h1><span id="qtSize">Quadtree Size: 0 KB</span><canvas id="canvas" width="800" height="800"></canvas><div><button id="playPause">Pause</button> <button id="step">Step</button> <label><input type="checkbox" id="incremental"> Incremental Update</label> <label><input type="checkbox" id="qtreegrids"> Qtree Visual</label></div><script>class QuadTree{constructor(t,e){this.boundary=t,this.capacity=e,this.points=[],this.divided=!1}containsPoint(t){return t.x>=this.boundary.x&&t.x<this.boundary.x+this.boundary.w&&t.y>=this.boundary.y&&t.y<this.boundary.y+this.boundary.h}subdivide(){const{x:t,y:e,w:s,h:i}=this.boundary,n=s/2,o=i/2,r={x:t+n,y:e,w:n,h:o},h={x:t,y:e,w:n,h:o},a={x:t+n,y:e+o,w:n,h:o},u={x:t,y:e+o,w:n,h:o};this.northeast=new QuadTree(r,this.capacity),this.northwest=new QuadTree(h,this.capacity),this.southeast=new QuadTree(a,this.capacity),this.southwest=new QuadTree(u,this.capacity),this.divided=!0;for(let t of this.points)this._insertToChildren(t);this.points=[]}_insertToChildren(t){this.northeast.containsPoint(t)?this.northeast.insert(t):this.northwest.containsPoint(t)?this.northwest.insert(t):this.southeast.containsPoint(t)?this.southeast.insert(t):this.southwest.containsPoint(t)?this.southwest.insert(t):this.points.push(t)}insert(t){if(!this.containsPoint(t))return!1;if(!this.divided){if(this.points.length<this.capacity)return this.points.push(t),!0;this.subdivide()}return this.northeast.insert(t)||this.northwest.insert(t)||this.southeast.insert(t)||this.southwest.insert(t)}remove(t,e){if(!(e.x>=this.boundary.x&&e.x<this.boundary.x+this.boundary.w&&e.y>=this.boundary.y&&e.y<this.boundary.y+this.boundary.h))return!1;if(this.divided){if(this.northeast.remove(t,e))return!0;if(this.northwest.remove(t,e))return!0;if(this.southeast.remove(t,e))return!0;if(this.southwest.remove(t,e))return!0}const s=this.points.indexOf(t);return s>-1&&(this.points.splice(s,1),!0)}clear(){this.points=[],this.divided=!1,this.northeast=this.northwest=this.southeast=this.southwest=null}show(t){t.strokeStyle="rgba(0,0,0,0.2)",t.strokeRect(this.boundary.x,this.boundary.y,this.boundary.w,this.boundary.h),this.divided&&(this.northeast.show(t),this.northwest.show(t),this.southeast.show(t),this.southwest.show(t))}intersects(t){return!(t.x+t.w<this.boundary.x||t.x>this.boundary.x+this.boundary.w||t.y+t.h<this.boundary.y||t.y>this.boundary.y+this.boundary.h)}query(t,e=[]){if(!this.intersects(t))return e;for(let s of this.points)s.x>=t.x&&s.x<t.x+t.w&&s.y>=t.y&&s.y<t.y+t.h&&e.push(s);return this.divided&&(this.northeast.query(t,e),this.northwest.query(t,e),this.southeast.query(t,e),this.southwest.query(t,e)),e}}const canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),width=canvas.width,height=canvas.height,capacity=4;let quad=new QuadTree({x:0,y:0,w:width,h:height},4);const gravity=2;let points=[];const numPoints=1e3;for(let t=0;t<1e3;t++){const t=1+8*Math.random();let e={x:Math.random()*width,y:Math.random()*height,r:t,rr:80,vx:2*Math.random()-1,vy:2*Math.random()-1};points.push(e),quad.insert(e)}let running=!0,incremental=!1,qtreegrids=!1;function resolveCollision(t,e){let s=e.x-t.x,i=e.y-t.y,n=Math.hypot(s,i);if(0===n){const t=2*Math.random()*Math.PI;s=.01*Math.cos(t),i=.01*Math.sin(t),n=.01}const o=s/n,r=i/n,h=-r,a=o,u=t.vx*o+t.vy*r,d=t.vx*h+t.vy*a,c=e.vx*o+e.vy*r,y=e.vx*h+e.vy*a,m=t.r,l=e.r,x=(u*(m-l)+2*l*c)/(m+l),v=(c*(l-m)+2*m*u)/(m+l);t.vx=.99*(x*o+d*h),t.vy=.99*(x*r+d*a),e.vx=.99*(v*o+y*h),e.vy=.99*(v*r+y*a);const g=t.r+e.r-n;if(g>0){const s=g/(m+l);t.x-=o*s*l,t.y-=r*s*l,e.x+=o*s*m,e.y+=r*s*m}}document.getElementById("playPause").onclick=function(){running=!running,this.textContent=running?"Pause":"Play"},document.getElementById("incremental").onclick=function(){incremental=this.checked},document.getElementById("qtreegrids").onclick=function(){qtreegrids=this.checked};let lastTimestamp=performance.now();function update(){const t=performance.now();let e=Math.min(t-lastTimestamp,20)/1e3;lastTimestamp=t;for(let t of points){t.vy+=2*e;const s={x:t.x-4*t.r,y:t.y-4*t.r,w:t.rr,h:t.rr},i=quad.query(s);for(let e of i){if(e===t)continue;const s=e.x-t.x,i=e.y-t.y;Math.hypot(s,i)<t.r+e.r&&resolveCollision(t,e)}if(isDragging){const t=BOX_SIZE/2,s={x:mouseX-t,y:mouseY-t,w:BOX_SIZE,h:BOX_SIZE},i=quad.query(s);for(let t of i)t.vx=mouseXv+(mouseX-t.x)*e*10,t.vy=mouseYv+(mouseY-t.y)*e*10}}for(let t of points)t.x+=t.vx,t.y+=t.vy,(t.x<t.r||t.x>width-t.r)&&(t.vx*=-1,t.x=Math.max(t.r,Math.min(t.x,width-t.r))),(t.y<t.r||t.y>height-t.r)&&(t.vy*=-1,t.y=Math.max(t.r,Math.min(t.y,height-t.r)));quad.clear();for(let t of points)quad.insert(t)}let isDragging=!1,mouseX=0,mouseY=0,mouseXv=0,mouseYv=0,_prevMouseX=0,_prevMouseY=0;const BOX_SIZE=40;function draw(){ctx.clearRect(0,0,width,height);for(let t of points)ctx.beginPath(),ctx.arc(t.x,t.y,t.r,0,2*Math.PI),ctx.fillStyle="steelblue",ctx.fill();if(qtreegrids&&quad.show(ctx),isDragging){const t=BOX_SIZE/2,e=mouseX-t,s=mouseY-t;ctx.strokeStyle="red",ctx.lineWidth=2,ctx.strokeRect(e,s,BOX_SIZE,BOX_SIZE);const i=quad.query({x:e,y:s,w:BOX_SIZE,h:BOX_SIZE});for(let t of i)ctx.beginPath(),ctx.arc(t.x,t.y,t.r+1,0,2*Math.PI),ctx.strokeStyle="orange",ctx.lineWidth=2,ctx.stroke()}}canvas.addEventListener("mousedown",(t=>{isDragging=!0;const e=canvas.getBoundingClientRect();mouseX=t.clientX-e.left,mouseY=t.clientY-e.top,_prevMouseX=mouseX,_prevMouseY=mouseY,mouseXv=0,mouseYv=0})),canvas.addEventListener("mousemove",(t=>{if(!isDragging)return;const e=canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;mouseXv=s-_prevMouseX,mouseYv=i-_prevMouseY,_prevMouseX=s,_prevMouseY=i,mouseX=s,mouseY=i})),canvas.addEventListener("mouseup",(()=>{isDragging=!1})),canvas.addEventListener("mouseleave",(()=>{isDragging=!1}));let frameCount=0,stepRequested=!1;function animate(){if(!running||incremental&&!stepRequested||(update(),draw(),incremental&&(stepRequested=!1)),++frameCount>60){frameCount=0;try{const t=(new Blob([JSON.stringify(quad)]).size/1024).toFixed(2);document.getElementById("qtSize").textContent=`Quadtree Size: ${t} KB`}catch(t){document.getElementById("qtSize").textContent="Quadtree Size: N/A"}}requestAnimationFrame(animate)}document.getElementById("step").onclick=function(){incremental?stepRequested=!0:running||(update(),draw())},draw(),requestAnimationFrame(animate)</script></body></html>