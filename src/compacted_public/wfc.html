<!-- minified by avy <3 -->
<!DOCTYPE html><html><head><meta charset="utf-8"><title>Wave Function Collapse Demo</title><style>body{font-family:sans-serif}canvas{border:1px solid #333;margin:10px}label{margin-right:1em}</style></head><body><h1>Wave Function Collapse Demo</h1><div><h2>Sample Drawing</h2><canvas id="sampleCanvas" width="200" height="200"></canvas><br><input type="color" id="drawColor" value="#000000"> <button id="clearSample">Clear</button><p>Click on the grid to paint cells.</p></div><div><h2>Settings</h2><label>Tile Size (in cells): <input type="number" id="tileSize" value="2" min="1"></label> <label>Output Grid Width (tiles): <input type="number" id="outputWidth" value="20" min="1"></label> <label>Output Grid Height (tiles): <input type="number" id="outputHeight" value="20" min="1"></label> <button id="runWFC">Run Wave Function Collapse</button></div><div><h2>Output</h2><canvas id="outputCanvas" width="400" height="400"></canvas></div><script>const sampleCanvas=document.getElementById("sampleCanvas"),sampleCtx=sampleCanvas.getContext("2d"),sampleCellSize=20,sampleCols=sampleCanvas.width/20,sampleRows=sampleCanvas.height/20;let sampleGrid=[];function initSampleGrid(){sampleGrid=[];for(let t=0;t<sampleRows;t++){let t=[];for(let e=0;e<sampleCols;e++)t.push("#ffffff");sampleGrid.push(t)}}function drawSampleGrid(){for(let t=0;t<sampleRows;t++)for(let e=0;e<sampleCols;e++)sampleCtx.fillStyle=sampleGrid[t][e],sampleCtx.fillRect(20*e,20*t,20,20),sampleCtx.strokeStyle="#ddd",sampleCtx.strokeRect(20*e,20*t,20,20)}initSampleGrid(),drawSampleGrid();const drawColorInput=document.getElementById("drawColor");function extractPatterns(t){const e={};for(let n=0;n<=sampleRows-t;n++)for(let o=0;o<=sampleCols-t;o++){let l=[];for(let e=0;e<t;e++){let r=[];for(let l=0;l<t;l++)r.push(sampleGrid[n+e][o+l]);l.push(r)}const r=JSON.stringify(l);e[r]?e[r].count++:e[r]={pattern:l,count:1}}const n=[];for(let t in e)n.push({key:t,pattern:e[t].pattern,count:e[t].count});return n}function computeCompatibility(t,e){const n=[];for(let e=0;e<t.length;e++)n[e]={up:[],right:[],down:[],left:[]};for(let o=0;o<t.length;o++)for(let l=0;l<t.length;l++){let r=!0;for(let n=0;n<e;n++)if(t[l].pattern[e-1][n]!==t[o].pattern[0][n]){r=!1;break}r&&n[o].up.push(l);let s=!0;for(let n=0;n<e;n++)if(t[l].pattern[0][n]!==t[o].pattern[e-1][n]){s=!1;break}s&&n[o].down.push(l);let a=!0;for(let n=0;n<e;n++)if(t[l].pattern[n][e-1]!==t[o].pattern[n][0]){a=!1;break}a&&n[o].left.push(l);let i=!0;for(let n=0;n<e;n++)if(t[l].pattern[n][0]!==t[o].pattern[n][e-1]){i=!1;break}i&&n[o].right.push(l)}return n}function runWFC(t,e,n,o,l){const r=o.length,s=[];for(let t=0;t<n;t++){const t=[];for(let n=0;n<e;n++){const e=[];for(let t=0;t<r;t++)e.push(t);t.push({collapsed:!1,options:e})}s.push(t)}function a(t,o){const l=[];return t>0&&l.push({i:t-1,j:o,direction:"up"}),t<n-1&&l.push({i:t+1,j:o,direction:"down"}),o>0&&l.push({i:t,j:o-1,direction:"left"}),o<e-1&&l.push({i:t,j:o+1,direction:"right"}),l}function i(t){let e=0;for(let n of t)e+=o[n].count;let n=Math.random()*e;for(let e of t)if(n-=o[e].count,n<=0)return e;return t[t.length-1]}const p=[];function u(){for(;p.length>0;){const{i:t,j:e}=p.shift(),n=s[t][e],o=a(t,e);for(let t of o){const e=t.i,o=t.j,r=t.direction,a=s[e][o];if(a.collapsed)continue;const i=[];for(let t of a.options){let e=!1;for(let o of n.options){let n;if("up"===r?n=l[t].down:"down"===r?n=l[t].up:"left"===r?n=l[t].right:"right"===r&&(n=l[t].left),n.includes(o)){e=!0;break}}e&&i.push(t)}if(i.length<a.options.length&&(a.options=i,p.push({i:e,j:o}),0===a.options.length))return console.error("No options left at",e,o),!1}}return!0}for(;;){let t=1/0,o=-1,l=-1;for(let r=0;r<n;r++)for(let n=0;n<e;n++){const e=s[r][n];!e.collapsed&&e.options.length<t&&(t=e.options.length,o=r,l=n)}if(t===1/0)break;const r=s[o][l];if(0===r.options.length)return console.error("Collapse failed at",o,l),null;const a=i(r.options);if(r.options=[a],r.collapsed=!0,p.push({i:o,j:l}),!u())return console.error("Propagation failed, restarting..."),null}return s}sampleCanvas.addEventListener("click",(function(t){const e=sampleCanvas.getBoundingClientRect(),n=t.clientX-e.left,o=t.clientY-e.top,l=Math.floor(n/20),r=Math.floor(o/20);sampleGrid[r][l]=drawColorInput.value,drawSampleGrid()})),document.getElementById("clearSample").addEventListener("click",(function(){initSampleGrid(),drawSampleGrid()}));const outputCanvas=document.getElementById("outputCanvas"),outputCtx=outputCanvas.getContext("2d");function renderOutput(t,e,n){const o=t.length,l=t[0].length,r=20;outputCanvas.width=l*e*r,outputCanvas.height=o*e*r;for(let s=0;s<o;s++)for(let o=0;o<l;o++){const l=t[s][o];if(l.collapsed){const t=n[l.options[0]].pattern;for(let n=0;n<e;n++)for(let l=0;l<e;l++)outputCtx.fillStyle=t[n][l],outputCtx.fillRect((o*e+l)*r,(s*e+n)*r,r,r)}}}document.getElementById("runWFC").addEventListener("click",(function(){const t=parseInt(document.getElementById("tileSize").value),e=parseInt(document.getElementById("outputWidth").value),n=parseInt(document.getElementById("outputHeight").value),o=extractPatterns(t);if(0===o.length)return void alert("Not enough sample data for the chosen tile size.");const l=runWFC(t,e,n,o,computeCompatibility(o,t));l?renderOutput(l,t,o):alert("Wave Function Collapse failed. Try a different sample or settings.")}))</script></body></html>