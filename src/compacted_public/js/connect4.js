// minified by avy <3
function delay(e){return new Promise((t=>setTimeout(t,e)))}function getRandomUint32(){return Math.floor(Math.random()*2**32)>>>0}const tokenColYellow="#ffff01",tokenColRed="#e20004",dropSpeed=200;let visualToken,visualTokenText,selectedCol;import{transTable,moveStack,cols,rows,connectIn,redIsAI,yelIsAI,setRedIsAI,setYelIsAI,turn,gameState,tokenGrid,tokenGridHeights,setCol,setRow,setConnectIn,resetGame,rawDrop,rawUndrop,genValidDrops,minmax,myHuge,myHuge2,nodes,resetNodes,IntStack}from"./modules/c4main.js";const redoStack=new IntStack;let vCellWidth,vCellHeight,aiThinkTime=800,lastDrop=1,miniMaxIsProccesing=!1,tokenOffseter=0;function tokenVisual(e,t,n){const o=document.createElement("div"),i=e.getBoundingClientRect();o.style.position="absolute",o.style.top=n?i.top-i.height/2+"px":i.top+i.height/2+"px",o.style.left=i.left+i.width/2+"px",o.style.width=.8*i.width+"px",o.style.height=.8*i.height+"px",o.style.backgroundColor=t,o.style.borderRadius="50%",o.style.transform="translate(-50%, -50%)",o.style.zIndex="1",o.style.boxShadow=`inset ${tokenOffseter/2}px ${tokenOffseter/2}px `+tokenOffseter+"px "+tokenOffseter/8+"px rgba(0, 0, 0, 0.3)",o.style.transition="top 200ms ease-in";if(document.getElementById("tokenContainer").appendChild(o),n){const e=n.getBoundingClientRect();o.style.top=i.top-i.height/2+"px",o.style.left=i.left+i.width/2+"px",requestAnimationFrame((()=>{o.style.top=e.top+e.height/2+"px",o.style.left=e.left+e.width/2+"px"}))}}function circleOutline(e){if(!e)return;const t=document.createElement("div");t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.width="85%",t.style.height="85%",t.style.background="none",t.style.border=tokenOffseter/4+"px solid white",t.style.borderRadius="50%",t.style.transform="translate(-50%, -50%)",t.style.zIndex="11";const n=document.createElement("div");n.innerText="X",n.style.position="absolute",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.fontSize=2*tokenOffseter+"px",n.style.color="white",n.style.zIndex="12",t.appendChild(n),e.style.position="relative",e.appendChild(t)}function findWin(e,t){const n=3-turn;if(tokenGridHeights[e]>=connectIn){let o=1,i=[];for(let l=1;l<connectIn&&tokenGrid[e][t-l]==n;++l)if(++o,i.push(document.getElementById(`${e}c${t-l}`)),o==connectIn)return i.forEach(((e,t)=>{circleOutline(e)})),turn}let o=1,i=[];for(let l=1;l<connectIn&&(tokenGrid[e+l]&&tokenGrid[e+l][t]==n);++l)if(++o,i.push(document.getElementById(`${e+l}c${t}`)),o==connectIn)return i.forEach(((e,t)=>{circleOutline(e)})),turn;for(let l=1;l<connectIn&&(tokenGrid[e-l]&&tokenGrid[e-l][t]==n);++l)if(++o,i.push(document.getElementById(`${e-l}c${t}`)),o==connectIn)return i.forEach(((e,t)=>{circleOutline(e)})),turn;let l=1,s=[];for(let o=1;o<connectIn&&(tokenGrid[e+o]&&tokenGrid[e+o][t+o]&&tokenGrid[e+o][t+o]==n);++o)if(++l,s.push(document.getElementById(`${e+o}c${t+o}`)),l==connectIn)return s.forEach(((e,t)=>{circleOutline(e)})),turn;for(let o=1;o<connectIn&&(tokenGrid[e-o]&&tokenGrid[e-o][t-o]&&tokenGrid[e-o][t-o]==n);++o)if(++l,s.push(document.getElementById(`${e-o}c${t-o}`)),l==connectIn)return s.forEach(((e,t)=>{circleOutline(e)})),turn;let r=1,a=[];for(let o=1;o<connectIn&&(tokenGrid[e+o]&&tokenGrid[e+o][t-o]&&tokenGrid[e+o][t-o]==n);++o)if(++r,a.push(document.getElementById(`${e+o}c${t-o}`)),r==connectIn)return a.forEach(((e,t)=>{circleOutline(e)})),turn;for(let o=1;o<connectIn&&(tokenGrid[e-o]&&tokenGrid[e-o][t+o]&&tokenGrid[e-o][t+o]==n);++o)if(++r,a.push(document.getElementById(`${e-o}c${t+o}`)),r==connectIn)return a.forEach(((e,t)=>{circleOutline(e)})),turn;return 0}function visualizeGrid(e){document.getElementById("tokenContainer").innerHTML="";for(let t=0;t<cols;t++)for(let n=0;n<rows;n++){const o=tokenGrid[t][n],i=document.getElementById(`${t}c${n}`);if(1==o)(async()=>{for(;i.firstChild;)i.removeChild(i.firstChild);if(t!=lastDrop||n!=tokenGridHeights[t]-1||e)tokenVisual(i,"#e20004");else{tokenVisual(document.getElementById(`${t}c${rows-1}`),"#e20004",i)}})();else if(2==o)(async()=>{for(;i.firstChild;)i.removeChild(i.firstChild);if(t!=lastDrop||n!=tokenGridHeights[t]-1||e)tokenVisual(i,"#ffff01");else{tokenVisual(document.getElementById(`${t}c${rows-1}`),"#ffff01",i)}})();else for(;i.firstChild;)i.removeChild(i.firstChild)}}function unDropToken(){1!=miniMaxIsProccesing&&((moveStack.stack[moveStack.top]||0==moveStack.stack[moveStack.top])&&redoStack.push(moveStack.stack[moveStack.top]),rawUndrop(),lastDrop=moveStack.stack[moveStack.top],positionToken(visualToken,lastDrop),visualizeGrid(!0))}function reDropToken(){if(1==miniMaxIsProccesing)return;const e=redoStack.pop();(e||0==e)&&(rawDrop(e),lastDrop=e,positionToken(visualToken,e),visualizeGrid(),0!=gameState&&(console.log("CONNECT 4",turn,gameState),0!=findWin(lastDrop,tokenGridHeights[lastDrop]-1)&&circleOutline(document.getElementById(`${lastDrop}c${tokenGridHeights[lastDrop]-1}`))))}async function mainAI(){if(1==miniMaxIsProccesing)return;const e=document.getElementById("insidebar"),t=document.getElementById("drawbar"),n=document.getElementById("eval");let o=0,i=genValidDrops()[0],l=[],s=1;miniMaxIsProccesing=!0;const r=rows*cols-moveStack.top+2,a=performance.now()+aiThinkTime;for(let e=2;e<r;e++){let t=!1;if(2==turn){t=!0;const[n,s,r]=await minmax(0,e,t,-myHuge,myHuge);o=n,i=s,l=r}else{const[n,s,r]=await minmax(0,e,t,-myHuge,myHuge);o=n,i=s,l=r}if(s=e,positionToken(visualToken,i),visualTokenText&&(visualTokenText.innerText=String(e)),performance.now()>a)break}null==i&&await delay(1),null!=l&&l.reverse();const c=Math.abs(o);let d=50+Math.log(c+1)/Math.log(myHuge2+1)*50;if(c>=myHuge-r?(d=100,n.textContent="M"+((myHuge-c)/2-.5)):n.textContent=Math.floor(o)/10,e.style.height=o>0?`${clamp(d,0,100)}%`:+clamp(100-d,0,100)+"%",null!=l&&l[0]){const e=l[0][1],n=l[0][2]/(1+c/100);let i=100-100*(Math.abs(e-o)/(c+n));console.log("DRAW?",i),i>100&&(i=100),i<0&&(i=0),t.style.height=2*i+"%"}2==turn?console.log("YEL_AI MOVE",o,i,s):console.log("RED_AI MOVE",o,i,s),console.log("NODES:",nodes,"TRANS:",transTable.map.size,"MOVEORDER:",l),console.log("timetaken:",(performance.now()-a)/1e3),resetNodes(),miniMaxIsProccesing=!1,visualTokenText&&(visualTokenText.innerText=""),dropToken(i)}function dropToken(e){if(1!=miniMaxIsProccesing)if(redoStack.reset(),rawDrop(e),lastDrop=e,positionToken(visualToken,selectedCol),visualizeGrid(),0!=gameState){if(console.log("CONNECT 4",turn,gameState),0!=findWin(lastDrop,tokenGridHeights[lastDrop]-1))circleOutline(document.getElementById(`${lastDrop}c${tokenGridHeights[lastDrop]-1}`));else for(let e=0;e<cols;e++)if(0!=findWin(e,tokenGridHeights[e]-1)){circleOutline(document.getElementById(`${e}c${tokenGridHeights[e]-1}`));break}}else(1==turn&&redIsAI||2==turn&&yelIsAI)&&mainAI()}function clamp(e,t,n){return Math.max(t,Math.min(n,e))}function resetGameAndUI(){if(1==miniMaxIsProccesing)return;resetGame(),selectedCol=Math.floor(cols/2);document.getElementById("tokenContainer").innerHTML=""}let prevRow=rows,prevCol=cols;function createGrid(){prevRow==rows&&prevCol==cols||resetGameAndUI(),prevRow=rows,prevCol=cols;const e=document.getElementById("Board");e.innerHTML="";const t=Math.min(cols,rows)/Math.max(cols,rows),n=.12*Math.min(window.innerWidth,window.innerHeight)*t**.2,o=(cols/2+rows)/1.5,i=cols*n/o*6,l=rows*n/o*6;e.style.borderRadius=(i+l)/100+"px",e.style.width=`${i}px`,e.style.height=`${l}px`;const s=document.createElement("div");s.classList.add("evalBar"),e.appendChild(s);for(let t=0;t<cols;t++){const n=document.createElement("div");n.classList.add("column"),n.id=`column-${t}`,n.setAttribute("numindex",t);for(let e=0;e<rows;e++){const o=document.createElement("div");o.classList.add("cell"),o.id=`${t}c${e}`,n.appendChild(o)}e.appendChild(n)}setTimeout((()=>{visualToken&&resizeToken(visualToken)}),400),setTimeout((()=>{visualToken&&(positionToken(visualToken,selectedCol),updateTopbarPosition(),0==miniMaxIsProccesing&&visualizeGrid(!0))}),400)}function heightChange(e){parseInt(e.target.value)&&(console.log("New height:",e.target.value),setRow(clamp(parseInt(e.target.value),1,20)),createGrid(),e.target.value=rows)}function widthChange(e){parseInt(e.target.value)&&(console.log("New width:",e.target.value),setCol(clamp(parseInt(e.target.value),1,20)),createGrid(),e.target.value=cols)}function connectInChange(e){parseInt(e.target.value)&&(console.log("New Connect In:",e.target.value),setConnectIn(clamp(parseInt(e.target.value),2,20)),e.target.value=connectIn)}function thinktimeChange(e){parseInt(e.target.value)&&(aiThinkTime=parseInt(e.target.value),console.log("New ThinkTime:",aiThinkTime),aiThinkTime=clamp(aiThinkTime,1,8e3),e.target.value=aiThinkTime)}function resizeToken(e){const t=document.querySelector(".cell");if(t){const n=t.getBoundingClientRect();vCellWidth=n.width,vCellHeight=n.height;const o=.8*Math.min(n.width,n.height);tokenOffseter=o/8,e.style.width=`${o}px`,e.style.height=`${o}px`,visualTokenText.style.fontSize=2*tokenOffseter+"px"}}function positionToken(e,t){const n=document.getElementById(`${t}c${rows-1}`);if(!n)return;const o=n.getBoundingClientRect(),i=o.left+o.width/2,l=o.top-o.height/2,s=i-e.offsetWidth/2,r=l-e.offsetHeight/2;e.style.position="absolute",e.style.left=`${s}px`,e.style.top=`${r}px`,e.style.boxShadow="inset 0 0 "+tokenOffseter+"px "+tokenOffseter+"px rgba(0, 0, 0, 0.1)",2==turn?(e.style.backgroundColor="#ffff01",visualTokenText.style.color="black"):(e.style.backgroundColor="#e20004",visualTokenText.style.color="white")}function updateTopbarPosition(){const e=document.getElementById("Board"),t=document.getElementById("topbar"),n=document.getElementById("insidebar"),o=document.getElementById("drawbar"),i=document.getElementById("eval"),l=e.getBoundingClientRect(),s=l.width/30;t.style.top=`${l.top}px`,t.style.left=`${l.right+s/2}px`,t.style.width=s+"px",t.style.height=`${l.height}px`,t.style.filter="brightness(90%)",t.style.backgroundColor="#e20004",i.style.fontSize=.5*s+"px",i.style.bottom=.2*s+"px",i.textContent="?",n.style.backgroundColor="#ffff01",n.style.width="100%",n.style.height="50%",o.style.width="100%",o.style.height="200%"}function clearGame(){1!=miniMaxIsProccesing&&(resetGameAndUI(),createGrid())}function yellowAi(e){setYelIsAI(!yelIsAI),e.textContent=`🟡 Yellow [${yelIsAI?"AI":"Human"}]`,console.log("yellow is ai set to",yelIsAI,turn),yelIsAI&&2==turn&&(console.log("USE AI"),mainAI())}function redAi(e){setRedIsAI(!redIsAI),e.textContent=`🔴 Red [${redIsAI?"AI":"Human"}]`,console.log("red is ai set to"),redIsAI&&1==turn&&(console.log("USE AI"),mainAI())}document.addEventListener("DOMContentLoaded",(function(){let e=window.location.href.split("?")[1];if(e){let t=e.split(",").map(Number);setCol(t[0]),setRow(t[1]),createGrid(),resetGameAndUI(),t.slice(2).forEach((e=>{let t=parseInt(e);(t||0==t)&&(rawDrop(t),selectedCol=t)}))}const t=document.getElementById("Board"),n=document.createElement("div");n.id="token",n.style.backgroundColor="#e20004";const o=document.createElement("div");o.innerText="",o.style.position="absolute",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.color="white",o.style.zIndex="12",n.appendChild(o),visualTokenText=o,visualToken=n,document.body.appendChild(n);const i=e=>{const o=function(e){const n=Array.from(t.getElementsByClassName("column"));let o=null,i=1/0;return n.forEach((t=>{const n=t.getBoundingClientRect(),l=n.left+n.width/2,s=Math.abs(e-l);s<i&&(i=s,o=t)})),o}(e.clientX||e.touches[0].clientX),i=t.getElementsByClassName("column");if(Array.from(i).forEach((e=>e.classList.remove("highlight"))),o){o.classList.add("highlight");const e=parseInt(o.getAttribute("numindex"));selectedCol!=e&&(selectedCol=e,0==miniMaxIsProccesing&&positionToken(n,selectedCol))}};t.addEventListener("mousemove",i),t.addEventListener("touchmove",i),createGrid();document.getElementById("cheight").addEventListener("input",heightChange);document.getElementById("cwidth").addEventListener("input",widthChange);document.getElementById("connectin").addEventListener("input",connectInChange);document.getElementById("thinktime").addEventListener("input",thinktimeChange),document.addEventListener("click",(function(e){"BUTTON"!=e.target.tagName&&"LABEL"!=e.target.tagName&&"INPUT"!=e.target.tagName&&0==gameState&&dropToken(selectedCol)}))})),window.addEventListener("resize",(function(){createGrid()}));export{yellowAi,redAi,unDropToken,reDropToken,clearGame};window.yellowAi=yellowAi,window.redAi=redAi,window.unDropToken=unDropToken,window.reDropToken=reDropToken,window.clearGame=clearGame;