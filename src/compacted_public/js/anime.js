// minified by avy <3
const mainAPIURL="https://api.jikan.moe/v4",speedMS=800;async function myCustomGet(e,t={}){const n=`${e}?${Object.entries(t).map((([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&")}`,a=await fetch(n,{method:"GET"});if(!a.ok)throw new Error(`HTTP error! Status: ${a.status}`);return await a.json()}function sleep(e){return new Promise((t=>setTimeout(t,e)))}function seededRandom(e){var t=1e4*Math.sin(e);return t-Math.floor(t)}function getAnimeName(e){return e.title_english?e.title_english:e.title}function blendColors(e,t,n=.5){const a=e=>parseInt(e,16);return"#"+[0,2,4].map((i=>Math.round(a(e.substr(i+1,2))*(1-n)+a(t.substr(i+1,2))*n).toString(16).padStart(2,"0"))).join("")}function getAnimeColor(e){const t=e.genres.some((e=>"Romance"===e.name)),n=e.genres.some((e=>"Mystery"===e.name)),a=e.genres.some((e=>"Drama"===e.name)),i=e.genres.some((e=>"Action"===e.name)),o=e.genres.some((e=>"Sports"===e.name)),s=e.genres.some((e=>"Comedy"===e.name)),r=e.genres.some((e=>"Slice of Life"===e.name)),l=e.genres.some((e=>"Suspense"===e.name)),m=e.genres.some((e=>"Sci-Fi"===e.name)),c=e.genres.some((e=>"Horror"===e.name)),d=e.genres.some((e=>"Fantasy"===e.name)),p=e.genres.some((e=>"Adventure"===e.name));let u;if(u=t?s?"#ff8cc6":"#ff57a1":n?r?"#803e73":l?"#5d1170":i?"#a81111":"#800080":a?i?"#ff5500":"#b25c5c":o?"#1E90FF":i?s?"#ffc100":"#ffa200":s?"#FFEB3B":r?"#b8ff9d":l?"#4b008e":"#A8B8A1",m){u=blendColors(u,"#5eacff",1/e.genres.length)}if(c){u=blendColors(u,"#420000",1.8/e.genres.length)}if(d&&p){u=blendColors(u,"#1db01d",1.4/e.genres.length)}if(s&&!t){u=blendColors(u,"#FFEB3B",1/e.genres.length)}return u}async function formRecomendations(e){let t=[];try{(await myCustomGet(mainAPIURL+"/anime/"+e+"/recommendations")).data.slice(0,4).forEach((e=>{t.push({mal_id:e.entry.mal_id,votes:e.votes,name:e.entry.title})}))}catch(e){console.warn(e)}return t}let animeMap=new Map,nodes=[],links=[],isPaused=!0;function drawGraph(){const e=12*Math.max(window.innerWidth,window.innerHeight),t=e,n=e,a=d3.select("#graph").attr("width",t).attr("height",n);a.selectAll(".link").remove(),a.selectAll(".node").remove(),a.selectAll(".node-label").remove(),nodes.forEach((function(e){const a=function(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return t<0?-t:t}(e.color)+e.id%2;e.x=seededRandom(a)*t,e.y=seededRandom(a+1)*n}));const i=nodes.map((e=>e.x)),o=nodes.map((e=>e.y)),s=(Math.min(...i)+Math.max(...i))/2,r=(Math.min(...o)+Math.max(...o))/2;(document.documentElement||document.body).scrollTo({top:r-window.innerHeight/2,left:s-window.innerWidth/2});const l=d3.forceSimulation(nodes).force("link",d3.forceLink(links).id((e=>e.id)).distance((e=>e.distance))).force("charge",d3.forceManyBody().strength(-400)).force("center",d3.forceCenter(t/2,n/2)).alphaDecay(.005),m=a.append("g").selectAll(".link").data(links).enter().append("line").attr("class","link").style("opacity",(e=>e.opac)),c=a.append("g").selectAll(".node").data(nodes).enter().append("circle").attr("class","node").attr("r",(e=>e.size?2+e.size:4)).style("fill",(e=>e.color?e.color:"gray")).on("click",(function(e,t){window.open(t.url,"_blank")})).on("mouseover",(function(e,t){m.style("opacity",(e=>e.source.id===t.id||e.target.id===t.id?1:.1)),c.style("opacity",(e=>e.id===t.id||links.some((n=>n.source.id===t.id&&n.target.id===e.id||n.target.id===t.id&&n.source.id===e.id))?1:.1)),d.style("opacity",(e=>e.id===t.id||links.some((n=>n.source.id===t.id&&n.target.id===e.id||n.target.id===t.id&&n.source.id===e.id))?1:.1))})).on("mouseout",(function(){m.style("opacity",(e=>e.opac)),c.style("opacity",1),d.style("opacity",1)})).call(d3.drag().on("start",(function(e,t){e.active||l.alphaTarget(.9).restart();t.fx=t.x,t.fy=t.y})).on("drag",(function(e,t){t.fx=e.x,t.fy=e.y})).on("end",(function(e,t){e.active||l.alphaTarget(0);t.fx=null,t.fy=null}))),d=a.append("g").selectAll(".node-label").data(nodes).enter().append("text").attr("class","node-label").attr("x",(e=>e.x)).attr("y",(e=>e.y)).attr("dy",-15).attr("text-anchor","middle").text((e=>e.name)).style("font-size",(e=>e.size?6+e.size/2+"px":"6px"));function p(){m.attr("x1",(e=>e.source&&e.target?e.source.x:0)).attr("y1",(e=>e.source&&e.target?e.source.y:0)).attr("x2",(e=>e.source&&e.target?e.target.x:0)).attr("y2",(e=>e.source&&e.target?e.target.y:0)),c.attr("cx",(e=>e.x)).attr("cy",(e=>e.y)),d.attr("x",(e=>e.x)).attr("y",(e=>e.y))}let u=Date.now();l.on("tick",(function(){if(isPaused)return;const e=Date.now();e-u<2e3||(u=e,p())})),l.on("end",(function(){p()}))}let lastAnimeMapString="";function visualize(){if(isPaused)return;try{const e=JSON.stringify(Array.from(animeMap.entries()));if(e===lastAnimeMapString)return void(lastAnimeMapString=e);lastAnimeMapString=e}catch(e){console.warn(e),alert(e)}nodes=[],links=[],animeMap.forEach(((e,t)=>{const n=e.anime;e.recoms.length;e.recoms.sort(((e,t)=>t.votes-e.votes)).forEach(((e,t)=>{const a=animeMap.get(e.mal_id);if(a){const i=a.anime,o=nodes.find((t=>t.id===e.mal_id));o?o.size=(o.size||0)+Math.max(e.votes/100,1)**.3:nodes.push({id:e.mal_id,name:getAnimeName(i),url:"https://myanimelist.net/anime/"+i.mal_id,score:i.score,color:getAnimeColor(i)});const s=e.votes/(t+1)*4;links.push({source:n.mal_id,target:e.mal_id,value:s,distance:Math.min(1/s*40**1.5,20),opac:Math.min(1,s/10)})}})),nodes.find((e=>e.id===n.mal_id))||nodes.push({id:n.mal_id,name:getAnimeName(n),url:"https://myanimelist.net/anime/"+n.mal_id,score:n.score,color:getAnimeColor(n)})}));const e=new Set(links.flatMap((e=>[e.source,e.target])));nodes=nodes.filter((t=>e.has(t.id))),drawGraph()}async function addAnime(e){if(animeMap.get(e.mal_id))return;if(e.score<7&&e.popularity>2e3&&!(e.year>=2016&&e.members>=2e5||e.year>=2020&&e.members>=1e5))return;if((e.members<1e4||e.score<6)&&e.popularity>2e3)return;if(0==e.popularity&&0==e.favorites)return;await sleep(800);const t=await formRecomendations(e.mal_id),n={mal_id:e.mal_id,genres:[...e.genres,...e.themes].map((({name:e})=>({name:e}))),favorites:e.favorites,popularity:e.popularity,score:e.score,title_english:e.title_english,title:e.title,year:e.year};animeMap.set(e.mal_id,{anime:n,recoms:t})}let selfGenElm=document.getElementById("sgen");async function animesNow(e){const t={sfw:!1,limit:25,page:e};try{const n=await myCustomGet(mainAPIURL+"/seasons/now",t);for(const t of n.data)await addAnime(t),selfGenElm.textContent=`(${animeMap.size}), page ${e} | ${getAnimeName(t)} /seasons/now`;visualize(),n&&n.pagination&&n.pagination.has_next_page&&(await sleep(800),await animesNow(e+1))}catch(t){console.warn(t),await sleep(1800),await animesNow(e)}}async function animesTopR(e){const t={filter:"favorite",rating:"r",sfw:!1,limit:25,page:e};try{const n=await myCustomGet(mainAPIURL+"/top/anime",t);for(const t of n.data)await addAnime(t),selfGenElm.textContent=`(${animeMap.size}) R+ page ${e} | ${getAnimeName(t)}`;visualize(),n&&n.pagination&&n.pagination.has_next_page&&(await sleep(800),await animesTopR(e+1))}catch(t){console.warn(t),await sleep(1800),await animesTopR(e)}}async function animesTopR17(e){const t={filter:"favorite",rating:"r17",sfw:!1,limit:25,page:e};try{const n=await myCustomGet(mainAPIURL+"/top/anime",t);for(const t of n.data)await addAnime(t),selfGenElm.textContent=`(${animeMap.size}) R-17 page ${e} | ${getAnimeName(t)}`;visualize(),n&&n.pagination&&n.pagination.has_next_page&&(await sleep(800),await animesTopR17(e+1))}catch(t){console.warn(t),await sleep(1800),await animesTopR17(e)}}async function animesTopPg13(e){const t={filter:"favorite",rating:"pg13",sfw:!1,limit:25,page:e};try{const n=await myCustomGet(mainAPIURL+"/top/anime",t);for(const t of n.data)await addAnime(t),selfGenElm.textContent=`(${animeMap.size}) PG-13 page ${e} | ${getAnimeName(t)}`;visualize(),n&&n.pagination&&n.pagination.has_next_page&&(await sleep(800),await animesTopPg13(e+1))}catch(t){console.warn(t),await sleep(1800),await animesTopPg13(e)}}let started=!1;async function start(){isPaused=!1,started=!0,visualize()}function createBidirectionalAnimeMap(e){const t=new Map;return e.forEach(((n,a)=>{const i={anime:n.anime,recoms:[...n.recoms]};t.has(a)||t.set(a,i),n.recoms.forEach((i=>{if(!t.has(i.mal_id)){const n=e.get(i.mal_id);n&&t.set(i.mal_id,{anime:n.anime,recoms:[...n.recoms]})}const o=t.get(i.mal_id);if(o){if(!o.recoms.some((e=>e.mal_id===a))){let e=i.votes;n.anime.year<o.anime.year&&(e/=2),o.recoms.push({mal_id:a,votes:e})}}}))})),t}let recomVoteStrength=8,recomVoteUnit=4,animeScoreStrength=4,punishYearsLessThan=2010,promoteEarlierAnimesMult=3,PEAM=promoteEarlierAnimesMult,allGenres={};function getConnectedAnimes(e){const t=createBidirectionalAnimeMap(animeMap);let n={},a={},i=-1/0;animeMap.forEach(((e,t)=>{e.anime&&(e.anime.year>i&&(i=e.anime.year),e.anime.genres.forEach((e=>{allGenres[e.name]||(allGenres[e.name]=1),a[e.name]?a[e.name]+=1:a[e.name]=1})))}));const o=document.getElementById("config-container");o.innerHTML="";const s=document.createElement("button");return s.textContent=PEAM==promoteEarlierAnimesMult?"ã€‡ Boost Newer Animes":"ðŸŸ¢ Boost Newer Animes",s.addEventListener("click",(()=>{promoteEarlierAnimesMult=PEAM==promoteEarlierAnimesMult?3*PEAM:PEAM,listSelectedAnimes()})),o.appendChild(s),Object.keys(allGenres).sort(((e,t)=>a[t]-a[e])).forEach((e=>{if(a[e]>10){const t=document.createElement("button");1==allGenres[e]?t.textContent=`ã€‡ ${e} (${a[e]})`:t.textContent=`ðŸŸ¢ ${e} (${a[e]})`,t.dataset.genre=e,t.addEventListener("click",(()=>{1==allGenres[e]?allGenres[e]=3:allGenres[e]=1,console.log(`${e} is now ${allGenres[e]}`),listSelectedAnimes()})),o.appendChild(t)}})),e.forEach((a=>{let o=new Set,s=[{mal_id:a,steps:0}];for(;s.length>0;){const{l_val:a,mal_id:r,steps:l}=s.shift(),m=t.get(r);if(!m||o.has(r))continue;o.add(r),n[r]||(n[r]={totalSteps:0,count:0}),e.includes(r)||(n[r].totalSteps+=l,n[r].count+=1);m.recoms.sort(((e,t)=>t.votes-e.votes)).forEach(((e,n)=>{if(!o.has(e.mal_id)){const a=e.votes*recomVoteStrength/(n+1)*4;let o=0,r=t.get(e.mal_id);r&&r.recoms&&(o=Math.min(r.recoms.length,16)*(10-r.anime.score)*animeScoreStrength,r.anime.year&&r.anime.year<=punishYearsLessThan&&r.anime.popularity>400&&(o*=2),r.anime.score<7&&(o*=2),r.anime.year==i?o/=4:r.anime.year>=i-2&&(o/=2));let c=0;r&&(r.anime.genres.forEach((e=>{1==allGenres[e.name]?c--:c+=r.anime.genres.length})),c/=r.anime.genres.length),r&&2+c>3&&console.log(2+c,getAnimeName(r.anime));let d=recomVoteUnit;r&&r.anime.year>m.anime.year&&(d/=promoteEarlierAnimesMult),s.push({mal_id:e.mal_id,steps:.5+(l+d/(1+a)+o/100)/(2+c)})}}))}})),Object.keys(n).filter((t=>!e.includes(t))).map((e=>{const t=n[e],a=t.count>0?t.totalSteps/t.count:1/0;return{mal_id:e,score:a===1/0?1/0:a}})).sort(((e,t)=>e.score-t.score))}const searchBar=document.getElementById("searchBar"),searchResults=document.getElementById("searchResults");let selectedAnimes={};const summaryCache={};function listSelectedAnimes(){const e=document.getElementById("list1");e.innerHTML="";for(let t in selectedAnimes){const n=selectedAnimes[t],a=getAnimeName(animeMap.get(n).anime),i=document.createElement("li");i.textContent=a,i.addEventListener("click",(()=>{delete selectedAnimes[t],listSelectedAnimes()})),e.appendChild(i)}const t=document.getElementById("list2");t.innerHTML="";const n=getConnectedAnimes(Object.values(selectedAnimes));if(n.length>0){const e=n.filter((e=>e.score!==1/0));e.length>0&&console.log("Worse recomendation: ",e[e.length-1])}let a=0;function i(){n.slice(a,a+6).forEach((e=>{a++;const n=animeMap.get(Number(e.mal_id)).anime,i=getAnimeName(n),s=(2*e.score).toFixed(1),r=document.createElement("div"),l=document.createElement("p"),m=document.createElement("p");m.style="text-align: right;padding-right: 40px;color:#888",m.innerText=`${n.year} â˜… ${n.score}`;const c=document.createElement("span");c.textContent=`${s}, `,c.classList.add("small-id"),l.appendChild(c),l.append(`${i}`),fetch(`api/anime?id=${e.mal_id}`,{method:"GET"}).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.text()})).then((async e=>{const t=/<meta\s+[^>]*?content="([^"]*)"[^>]*?>/g;let n,a;for(;null!==(n=t.exec(e));){const e=n[1],t=/name="([^"]+)"/.exec(n[0]);if(t){const n=t[1];if("twitter:image:src"===n){const t=document.createElement("img");t.src=e,t.style.width="160px",t.style.height="200px",t.style.objectFit="cover",t.style.float="right",t.style.paddingLeft="10px",l.appendChild(t)}else"description"===n&&(a=e.split("community and database. ")[1]||"")}}if(a){const e=(new DOMParser).parseFromString(a,"text/html").documentElement.textContent;let t=e.trim();try{if(summaryCache[e])t=summaryCache[e];else{let n=await fetch("https://api.smrzr.io/v1/summarize?&num_sentences=1",{referrer:"https://smrzr.io/",body:e.trim(),method:"POST"});t=await n.json(),t=t.summary,summaryCache[e]=t}}catch(e){console.log(e)}const n=document.createElement("p");n.textContent=t,n.style.marginTop="10px",n.style.fontStyle="italic",n.style.color="#777",l.appendChild(n)}})).catch((e=>{console.error("Error fetching data:",e)})),r.addEventListener("click",(()=>{window.open("https://myanimelist.net/anime/"+n.mal_id,"_blank")})),r.appendChild(m),r.appendChild(l),t.insertBefore(r,o)})),a+=6,a>=n.length&&(o.style.display="none")}const o=document.createElement("button");o.textContent="Load More",o.addEventListener("click",i),t.appendChild(o),i()}function printAnimeMapSize(e){const t=JSON.stringify(Array.from(e.entries())),n=(new TextEncoder).encode(t).length;var a;console.log(`animeData | size: ${a=n,(a/1048576).toFixed(2).toLocaleString()} MB`)}async function main(){try{const e=await fetch("/api/get-anime",{method:"POST",headers:{"Content-Type":"application/json"}});e.ok||(console.log("[FAILED] to get anime map"),alert("failed to get anime map [NET ERR]"));const t=await e.json(),n=Uint8Array.from(atob(t.base64CompressedData),(e=>e.charCodeAt(0))),a=pako.ungzip(n,{to:"string"}),i=JSON.parse(a);Object.entries(i).forEach((([e,{anime:t,recoms:n}])=>{const a={mal_id:t.mal_id,genres:t.genres.map((({name:e})=>({name:e}))),favorites:t.favorites,popularity:t.popularity,score:t.score,title_english:t.title_english,title:t.title,year:t.year};animeMap.set(t.mal_id,{anime:a,recoms:n})})),console.log("[Success] mainAnimeMap",animeMap),printAnimeMapSize(animeMap)}catch(e){console.error("[failed]:",e),alert("[FAILED TO LOAD animeMap], please refresh...")}}function htmlStart(e){0==started?(e.textContent="Running",start()):(console.log("Pause set to",!isPaused),"Running"==e.textContent?(isPaused=!0,e.textContent="Paused"):(isPaused=!1,e.textContent="Running",visualize()))}function htmlCommit(e){const t={pass:prompt("enter password:"),animeMap:Array.from(animeMap.entries())};e.textContent="Starting Commit",fetch("api/commit-anime",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((t=>{t.ok?e.textContent="Commit Ok!":alert(`HTTP error! status: ${t.status}`)})).catch((t=>{alert(`An error occurred: ${t.message}`),e.textContent="Commit Failed"}))}searchBar.addEventListener("input",(()=>{const e=document.getElementById("graph"),t=searchBar.value.toLowerCase();if(searchResults.innerHTML="",t.length<1)return;let n=0;if(animeMap.forEach(((a,i)=>{if(n>=20)return;const o=a.anime,s=getAnimeName(o);if(o.title.toLowerCase().includes(t)||s.toLowerCase().includes(t)){n++;const t=document.createElement("li"),a=Array.from(e.querySelectorAll("text")).find((e=>e.textContent.trim()===s));t.innerHTML=a?`${s} <span class="small-id">id_${o.mal_id}</span>`:`<span style="color: red;">${s}</span> <span class="small-id">id_${o.mal_id}</span>`,t.addEventListener("click",(()=>{if(selectedAnimes[i]=i,listSelectedAnimes(),a){const e=a.getBoundingClientRect(),t=document.documentElement||document.body;t.scrollTo({left:t.scrollLeft+e.left-t.clientWidth/2+e.width/2,top:t.scrollTop+e.top-t.clientHeight/2+e.height/2,behavior:"smooth"})}})),searchResults.appendChild(t)}})),!searchResults.hasChildNodes()&&""!==t){const e=document.createElement("li");e.textContent="No results found.",searchResults.appendChild(e)}})),main();let startSelfGen=!1;async function htmlSelfGen(e){const t=prompt("enter password:");1!=startSelfGen&&"start"==t&&(startSelfGen=!0,animeMap=new Map,animeMap.clear(),console.log(animeMap),e.textContent="Self Generate (Starting)",console.log("starting self generaton",animeMap),await sleep(800),await animesNow(1),await sleep(800),console.log("starting r17 animes"),await animesTopR17(1),await sleep(800),console.log("starting pg13 animes"),await animesTopPg13(1),await sleep(800),console.log("starting r+ animes"),await animesTopR(1),e.textContent="Self Generate (Ended)",console.log(animeMap),printAnimeMapSize(animeMap))}function htmlConfig(e){const t=document.getElementById("config-container");"none"!==t.style.display&&t.style.display?t.style.display="none":(getConnectedAnimes([]),t.style.display="flex")}